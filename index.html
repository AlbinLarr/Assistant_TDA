<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Assistant TDA</title>
    
    <!-- 1. D√âPENDANCES -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&family=Raleway:wght@700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- 2. DESIGN SYSTEM -->
    <style>
        :root {
            --bg-deep: #020617;       /* Noir spatial */
            --primary: #D946EF;       /* Fuchsia N√©on */
            --primary-dim: rgba(217, 70, 239, 0.15);
            --accent: #06B6D4;        /* Cyan N√©on */
            --text-main: #F8FAFC;     /* Blanc √âtoile */
            --text-muted: #94A3B8;    /* Gris Poussi√®re d'√©toile */
            --touch-size: 48px;
        }

        body {
            font-family: 'Lexend', sans-serif;
            background-color: var(--bg-deep);
            /* Fond N√©buleuse Complexe */
            background-image: 
                radial-gradient(at 0% 0%, rgba(76, 29, 149, 0.4) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(217, 70, 239, 0.2) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(6, 182, 212, 0.2) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(15, 23, 42, 1) 0px, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: var(--text-main);
            font-size: 16px;
            overflow-x: hidden;
        }

        .font-display { font-family: 'Raleway', sans-serif; letter-spacing: 0.05em; }

        /* --- LOGO ANIM√â --- */
        .logo-spin { animation: spin-orbit 20s linear infinite; }
        .logo-pulse { animation: pulse-star 3s ease-in-out infinite; }
        
        @keyframes spin-orbit { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse-star { 0%, 100% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }

        /* --- CLASSES UTILITAIRES --- */

        .card-glass {
            background-color: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        /* Onglets Dossiers */
        .folder-scroll {
            display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 0.5rem; margin-bottom: 1rem; scrollbar-width: none; 
        }
        .folder-scroll::-webkit-scrollbar { display: none; } 

        .folder-tab {
            white-space: nowrap; padding: 0.5rem 1.25rem; border-radius: 99px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted); font-size: 0.9rem; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .folder-tab.active {
            background: transparent; color: var(--primary); border-color: var(--primary);
            font-weight: 700; box-shadow: 0 0 15px rgba(217, 70, 239, 0.3); text-shadow: 0 0 10px rgba(217, 70, 239, 0.5);
        }
        
        .folder-delete {
            width: 20px; height: 20px; border-radius: 50%; background: rgba(255,255,255,0.1); color: white;
            display: flex; align-items: center; justify-content: center; font-size: 12px; opacity: 0.7; transition: all 0.2s;
        }
        .folder-delete:hover { background: #EF4444; opacity: 1; box-shadow: 0 0 10px #EF4444; }

        /* Cartes de S√©lection */
        .select-card {
            background-color: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1rem;
            padding: 0.75rem; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.25rem; min-height: 90px;
        }
        .select-card:hover { background-color: rgba(255, 255, 255, 0.1); transform: translateY(-2px); border-color: rgba(255,255,255,0.2); }
        .select-card.active { background-color: rgba(217, 70, 239, 0.1); border-color: var(--primary); box-shadow: 0 0 20px rgba(217, 70, 239, 0.2) inset; }
        .select-card.active span { color: white; font-weight: 700; text-shadow: 0 0 8px var(--primary); }

        /* Champs & Boutons */
        .input-std {
            background: rgba(2, 6, 23, 0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem;
            padding: 0 1.25rem; height: 50px; color: white; width: 100%; outline: none; font-size: 1rem; transition: all 0.3s;
        }
        .input-std:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(6, 182, 212, 0.2); background: rgba(2, 6, 23, 0.8); }

        .btn-primary {
            background: linear-gradient(135deg, #D946EF 0%, #8B5CF6 100%); color: white; font-weight: 700;
            border-radius: 0.8rem; padding: 0 1.5rem; height: 50px; display: inline-flex; align-items: center; justify-content: center;
            transition: all 0.2s; box-shadow: 0 4px 15px rgba(217, 70, 239, 0.4); text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-primary:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .btn-primary:active { transform: scale(0.96); }

        .btn-ghost {
            background: transparent; color: var(--text-muted); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.8rem; padding: 0 1rem; height: 40px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .btn-ghost:hover { background: rgba(255,255,255,0.05); color: white; border-color: var(--accent); box-shadow: 0 0 10px rgba(6, 182, 212, 0.2); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Slider Custom */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; height: 40px; margin: 10px 0; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 4px; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; 
            background: var(--primary); cursor: pointer; margin-top: -9px; 
            box-shadow: 0 0 15px var(--primary); border: 2px solid white; transition: transform 0.1s; 
        }
        input[type=range]::-webkit-slider-thumb:active { transform: scale(1.2); }
    </style>
</head>
<body class="pb-24 md:pb-0">

    <!-- Feedback Hors Ligne -->
    <div id="offlineIndicator" class="hidden fixed top-0 w-full bg-red-600/90 text-white text-center text-xs font-bold py-2 z-[200] backdrop-blur-sm">
        üì° Mode Orbite (Hors ligne)
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed bottom-24 md:bottom-8 right-0 md:right-8 left-0 md:left-auto px-4 flex flex-col items-center md:items-end gap-2 z-[200] pointer-events-none"></div>

    <!-- SIDEBAR (PC) -->
    <aside class="hidden md:flex flex-col w-72 fixed left-0 top-0 h-full bg-[#020617]/80 backdrop-blur-xl border-r border-white/5 z-50 p-8">
        
        <!-- LOGO & TITRE -->
        <div class="mb-12 flex items-center gap-4">
            <!-- Logo SVG Int√©gr√© -->
            <div class="relative w-12 h-12 flex-shrink-0">
                <svg viewBox="0 0 100 100" class="w-full h-full overflow-visible">
                    <!-- Orbite -->
                    <circle cx="50" cy="50" r="40" fill="none" stroke="#D946EF" stroke-width="2" stroke-opacity="0.3" class="logo-spin" stroke-dasharray="10 10"/>
                    <!-- Plan√®te Centrale -->
                    <defs>
                        <radialGradient id="planetGrad" cx="30%" cy="30%" r="70%">
                            <stop offset="0%" stop-color="#A78BFA" />
                            <stop offset="100%" stop-color="#7C3AED" />
                        </radialGradient>
                    </defs>
                    <circle cx="50" cy="50" r="20" fill="url(#planetGrad)" class="drop-shadow-[0_0_15px_rgba(124,58,237,0.5)]" />
                    <!-- √âtoile (Id√©e) -->
                    <path d="M50 10 L53 20 L63 20 L55 28 L58 38 L50 32 L42 38 L45 28 L37 20 L47 20 Z" fill="#06B6D4" class="logo-pulse origin-center translate-y-[-35px]" />
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-extrabold text-white tracking-tight font-display leading-none">
                    Focus <span class="block text-transparent bg-clip-text bg-gradient-to-r from-[#D946EF] to-[#8B5CF6] text-lg">Galaxy</span>
                </h1>
            </div>
        </div>

        <nav class="flex-grow space-y-2" id="desktopNav"></nav>
        <div id="apiStatus" class="text-xs font-mono text-gray-600 border-t border-white/5 pt-4">Cl√© API : V√©rification...</div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="md:ml-72 min-h-screen transition-all duration-300 relative">
        <div class="max-w-3xl mx-auto p-4 md:p-12 relative">
            
            <!-- MODULE 1 : VIDE CERVEAU -->
            <section id="vide-cerveau" class="module-section animate-enter">
                <header class="flex justify-between items-end border-b border-white/10 pb-6 mb-8">
                    <div>
                        <h1 id="vcTitle" class="text-4xl font-extrabold text-white font-display drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">Mon Chaos</h1>
                        <p id="vcSubtitle" class="text-sm text-gray-400 mt-2">Videz votre t√™te pour mieux penser.</p>
                    </div>
                    <button onclick="Modals.open('partnerModal')" class="btn-ghost hover:border-[#D946EF] hover:text-[#D946EF] hover:shadow-[0_0_15px_rgba(217,70,239,0.3)]" style="height:auto; padding: 10px 15px;">
                        <span class="text-2xl mr-2">ü§ñ</span> 
                        <div class="text-left leading-tight">
                            <div class="font-bold">Planifier</div>
                            <div class="text-[10px] opacity-70">avec l'IA</div>
                        </div>
                    </button>
                </header>

                <!-- BARRE DE DOSSIERS -->
                <div class="flex items-center gap-2 mb-6">
                    <div id="folderList" class="folder-scroll flex-grow"></div>
                    <button onclick="Modules.VideCerveau.addFolder()" class="btn-ghost" style="width: 40px; height: 35px; padding:0; border-radius: 99px;" title="Nouveau Dossier">Ôºã</button>
                </div>

                <!-- Input -->
                <div class="flex gap-3 mb-8">
                    <input type="text" id="noteInput" class="input-std flex-grow" placeholder="Ajouter une t√¢che ici...">
                    <button onclick="Modules.VideCerveau.add()" class="btn-primary">Ajouter</button>
                </div>

                <div id="notesList" class="flex flex-col gap-3 pb-20"></div>
                
                <div id="resetFilterBtn" class="hidden mt-8 pb-20 animate-enter">
                    <button onclick="Modules.VideCerveau.resetFilter()" class="w-full py-4 border border-dashed border-white/20 rounded-xl text-gray-400 hover:text-white hover:border-[#06B6D4] hover:shadow-[0_0_20px_rgba(6,182,212,0.2)] transition-all">
                        ‚Üê Retour √† la liste compl√®te
                    </button>
                </div>
            </section>

            <!-- MODULE 2 : HABITUDES -->
            <section id="habits" class="module-section hidden animate-enter">
                <header class="border-b border-white/10 pb-6 mb-8">
                    <h1 class="text-4xl font-extrabold text-white font-display drop-shadow-lg">Rituels</h1>
                </header>
                <div class="card-glass">
                    <div id="habitsList" class="flex flex-col gap-2"></div>
                    <div class="flex gap-3 mt-6 pt-6 border-t border-white/10">
                        <input type="text" id="habitInput" class="input-std bg-transparent" placeholder="Nouvelle habitude...">
                        <button onclick="Modules.Habits.add()" class="btn-ghost text-2xl px-4">Ôºã</button>
                    </div>
                </div>
            </section>

            <!-- MODULE 3 : NUTRITION -->
            <section id="nutrition" class="module-section hidden animate-enter">
                <header class="border-b border-white/10 pb-6 mb-8">
                    <h1 class="text-4xl font-extrabold text-white font-display drop-shadow-lg">Nutrition</h1>
                </header>
                <div class="card-glass mb-8 relative overflow-hidden group border-t border-[#D946EF]/20">
                    <div class="absolute top-0 right-0 w-48 h-48 bg-[#D946EF] rounded-full mix-blend-screen filter blur-[90px] opacity-20 animate-float pointer-events-none"></div>
                    
                    <div class="relative z-10 text-center mb-6">
                        <h2 class="text-2xl font-bold text-white font-display">Menu <span id="menuDay" class="text-[#D946EF] text-shadow">du Jour</span></h2>
                    </div>
                    <div class="space-y-3 relative z-10">
                        <div class="flex justify-between items-center p-4 bg-black/30 rounded-xl border border-white/5 hover:border-[#D946EF]/40 transition-all hover:shadow-[0_0_15px_rgba(217,70,239,0.1)]">
                            <div><span class="text-xs font-bold text-gray-400 uppercase block mb-1 tracking-wider">Midi ‚òÄÔ∏è</span><span id="menuMidi" class="text-lg text-white font-medium">...</span></div>
                            <button onclick="Modules.Nutrition.getRecipe('midi')" class="btn-ghost" title="Recette">üçΩÔ∏è</button>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-black/30 rounded-xl border border-white/5 hover:border-[#06B6D4]/40 transition-all hover:shadow-[0_0_15px_rgba(6,182,212,0.1)]">
                            <div><span class="text-xs font-bold text-gray-400 uppercase block mb-1 tracking-wider">Soir üåô</span><span id="menuSoir" class="text-lg text-white font-medium">...</span></div>
                            <button onclick="Modules.Nutrition.getRecipe('soir')" class="btn-ghost" title="Recette">üçΩÔ∏è</button>
                        </div>
                    </div>
                    <button onclick="Modules.Nutrition.toggleWeekView()" class="w-full mt-6 text-sm text-gray-400 underline decoration-dotted hover:text-white" id="toggleWeekBtn">Voir toute la semaine</button>
                </div>
                <div id="weekView" class="hidden flex flex-col gap-2 animate-enter mb-8"></div>
                <div class="card-glass">
                    <h3 class="text-white font-bold mb-4 flex items-center gap-3"><span class="bg-[#D946EF] w-8 h-8 flex items-center justify-center rounded-lg text-sm shadow-[0_0_10px_rgba(217,70,239,0.5)]">ü§ñ</span> Coach Nutrition</h3>
                    <div class="flex gap-3 mb-4"><input type="text" id="chatInput" class="input-std bg-black/20" placeholder="Question nutrition ?"><button onclick="Modules.Nutrition.askBot()" class="btn-primary">Go</button></div>
                    <div id="chatResponse" class="hidden bg-black/20 p-4 rounded-xl border border-white/5 text-gray-300 leading-relaxed text-sm"></div>
                </div>
            </section>

        </div>
    </main>

    <!-- MODALS -->
    
    <!-- Modal Sas (Filtre IA) -->
    <div id="partnerModal" class="fixed inset-0 bg-[#020617]/90 backdrop-blur-xl z-[100] flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-200">
        <div class="bg-[#0F172A] border border-white/10 p-6 md:p-8 rounded-3xl w-full max-w-lg shadow-[0_0_50px_rgba(217,70,239,0.15)] relative transform scale-95 transition-transform duration-200" id="partnerModalContent">
            <div id="partnerLoader" class="hidden text-center py-12">
                <div class="animate-spin w-16 h-16 border-4 border-white/10 border-t-[#D946EF] rounded-full mx-auto mb-4 shadow-[0_0_20px_rgba(217,70,239,0.5)]"></div>
                <p class="text-gray-300 animate-pulse font-mono">Calcul de trajectoire...</p>
            </div>
            <div id="partnerContent" class="space-y-6 max-h-[85vh] overflow-y-auto pr-2 custom-scrollbar">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-white font-display">Plan de Vol</h2>
                    <p class="text-gray-400 text-sm">Initialisation des param√®tres de mission.</p>
                </div>
                
                <!-- 1. Jauge √ânergie -->
                <div class="bg-white/5 p-5 rounded-2xl border border-white/5 transition-all duration-300 hover:bg-white/10" id="energyContainer">
                    <div class="flex justify-between mb-4 items-center">
                        <span class="text-white font-bold text-sm uppercase tracking-wide opacity-80">1. R√©serves √ânergie</span>
                        <span id="energyText" class="text-[#D946EF] font-bold text-lg transition-all text-shadow-glow">√áa va üòê</span>
                    </div>
                    <input type="range" id="energyRange" min="0" max="100" step="5" value="50" oninput="Modules.VideCerveau.updateEnergyLabel(this.value)" class="w-full">
                    <div class="flex justify-between text-[10px] text-gray-500 font-bold uppercase tracking-widest px-1"><span>Vide</span><span>Plein</span></div>
                </div>

                <!-- 2. Intention -->
                <div>
                    <label class="block text-white font-bold mb-2 text-sm uppercase tracking-wide opacity-70">2. Mode Mental</label>
                    <div class="grid grid-cols-3 gap-2" id="intentionBtns"></div>
                </div>

                <!-- 3. Temps Disponible -->
                <div>
                    <label class="block text-white font-bold mb-2 text-sm uppercase tracking-wide opacity-70">3. Fen√™tre Temporelle</label>
                    <div class="grid grid-cols-3 gap-2" id="contextBtns"></div>
                </div>

                <!-- 4. Disponibilit√© -->
                <div>
                    <label class="block text-white font-bold mb-2 text-sm uppercase tracking-wide opacity-70">4. Canal Comms <span class="text-[10px] bg-white/10 px-2 py-0.5 rounded ml-2 normal-case text-gray-300">Optionnel</span></label>
                    <div class="grid grid-cols-3 gap-2" id="availabilityBtns"></div>
                </div>

                <!-- Actions -->
                <div class="flex gap-3 border-t border-white/10 pt-4 mt-2">
                    <button onclick="Modules.VideCerveau.applyFilter()" class="btn-primary flex-grow text-lg shadow-lg shadow-[#D946EF]/30">Lancer</button>
                    <button onclick="Modals.close('partnerModal')" class="btn-ghost">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal G√©n√©rique -->
    <div id="genericModal" class="fixed inset-0 bg-[#020617]/90 z-[100] flex items-center justify-center p-4 hidden opacity-0 transition-opacity">
        <div class="bg-[#0F172A] border border-white/10 p-6 rounded-3xl w-full max-w-lg max-h-[80vh] overflow-y-auto relative animate-enter shadow-2xl">
            <button onclick="Modals.close('genericModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl p-2">&times;</button>
            <h2 id="genericModalTitle" class="text-2xl font-bold text-[#D946EF] mb-4 font-display drop-shadow-lg">Titre</h2>
            <div id="genericModalContent" class="prose prose-invert text-gray-300 leading-relaxed"></div>
        </div>
    </div>

    <!-- NAV MOBILE -->
    <nav class="md:hidden fixed bottom-0 w-full bg-[#020617]/80 backdrop-blur-xl border-t border-white/10 p-2 z-50 flex justify-around pb-safe shadow-[0_-4px_20px_rgba(0,0,0,0.5)]">
        <!-- Rempli par JS -->
    </nav>

    <!-- ==========================================================================
         LOGIQUE (JAVASCRIPT)
         ========================================================================== -->
    <script>
        /**
         * CONFIGURATION
         */
        const CONFIG = {
            API_KEY: "AIzaSyBTv-PT9ghkqnHfBpQJ2-Rufbm3z-7fRow", // ‚ö†Ô∏è CL√â API ICI
            GEMINI_URL: "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent",
            MENU_DATA: { 
                "Lundi": { m: "Poulet moutarde + Riz", s: "Salade Lentilles" }, 
                "Mardi": { m: "Maquereau + Crudit√©s", s: "Omelette" }, 
                "Mercredi": { m: "P√¢tes", s: "L√©gumes + Jambon" }, 
                "Jeudi": { m: "Restes", s: "Dahl Lentilles" }, 
                "Vendredi": { m: "Wrap Thon", s: "Soupe" }, 
                "Samedi": { m: "Galettes", s: "Pizza" }, 
                "Dimanche": { m: "Poisson", s: "Omelette" } 
            },
            DAYS: ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"]
        };

        const PROMPTS = {
            suggestions: `Tu es un IA de bord. Analyse : √ânergie {ENERGY}% ({ENERGY_LABEL}), Intention {INTENTION}, Temps {DURATION}, Social {SOCIAL}. Trie ces t√¢ches (Format: [Dossier] Tache). JSON: {"suggestions": ["Tache 1", "Tache 2", "Tache 3"]}.`,
            defuse: `D√©coupe cette t√¢che en 3 √©tapes simples. Ton robotique bienveillant. JSON: {"steps": ["1...", "2..."]}.`,
            nutrition: `Expert nutrition spatiale. Court. Markdown.`,
            recipe: `Recette simple. Markdown.`
        };

        /**
         * OUTILS
         */
        const Utils = {
            Storage: {
                get: (key) => JSON.parse(localStorage.getItem(key) || "[]"),
                set: (key, val) => localStorage.setItem(key, JSON.stringify(val))
            },
            UI: {
                toast: (msg, type = 'info', undoCallback = null) => {
                    const container = document.getElementById('toastContainer');
                    const id = Date.now();
                    const el = document.createElement('div');
                    const bgClass = type === 'error' ? 'bg-red-900/90 border-red-500/50' : 'bg-[#0F172A]/90 border-[#D946EF]/50';
                    el.className = `pointer-events-auto w-full max-w-sm p-4 rounded-xl shadow-[0_0_15px_rgba(0,0,0,0.5)] flex items-center justify-between gap-4 backdrop-blur-xl border animate-enter text-white mb-2 ${bgClass}`;
                    let html = `<span class="text-sm font-medium">${msg}</span>`;
                    if (undoCallback) html += `<button id="undo-${id}" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg uppercase font-bold tracking-wide transition-colors">Annuler</button>`;
                    else html += `<button onclick="this.parentElement.remove()" class="opacity-50 hover:opacity-100 p-1">&times;</button>`;
                    el.innerHTML = html;
                    container.appendChild(el);
                    if (undoCallback) document.getElementById(`undo-${id}`).onclick = () => { undoCallback(); el.remove(); };
                    setTimeout(() => { if(el.parentElement) el.remove(); }, 5000);
                }
            },
            AI: {
                call: async (sys, user, isJson = false) => {
                    if (!CONFIG.API_KEY) { Utils.UI.toast("Erreur: Cl√© API manquante", "error"); return null; }
                    if (!navigator.onLine) { Utils.UI.toast("Erreur: Hors ligne", "error"); return null; }
                    try {
                        const response = await fetch(`${CONFIG.GEMINI_URL}?key=${CONFIG.API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: user }] }], systemInstruction: { parts: [{ text: sys }] } })
                        });
                        const data = await response.json();
                        let text = data.candidates[0].content.parts[0].text;
                        if (isJson) text = text.replace(/^```json|```/g, '').trim();
                        return isJson ? JSON.parse(text) : text;
                    } catch (e) {
                        console.error(e);
                        Utils.UI.toast("Erreur de transmission IA", "error");
                        return null;
                    }
                }
            }
        };

        const Modals = {
            open: (id) => {
                const el = document.getElementById(id);
                el.classList.remove('hidden');
                setTimeout(() => { el.classList.remove('opacity-0'); if(el.firstElementChild) el.firstElementChild.classList.remove('scale-95'); }, 10);
            },
            close: (id) => {
                const el = document.getElementById(id);
                el.classList.add('opacity-0');
                if(el.firstElementChild) el.firstElementChild.classList.add('scale-95');
                setTimeout(() => el.classList.add('hidden'), 200);
            },
            showGeneric: (title, html) => {
                document.getElementById('genericModalTitle').innerText = title;
                document.getElementById('genericModalContent').innerHTML = html;
                Modals.open('genericModal');
            }
        };

        const App = {
            currentTab: 'vide-cerveau',
            init: () => {
                window.addEventListener('online', () => document.getElementById('offlineIndicator').classList.add('hidden'));
                window.addEventListener('offline', () => document.getElementById('offlineIndicator').classList.remove('hidden'));
                
                const statusEl = document.getElementById('apiStatus');
                if(statusEl) {
                    if(CONFIG.API_KEY && CONFIG.API_KEY.length > 10) statusEl.innerHTML = 'Cl√© API : <span class="text-emerald-400">Active üü¢</span>';
                    else statusEl.innerHTML = 'Cl√© API : <span class="text-red-400">Inactive üî¥</span>';
                }

                Object.values(Modules).forEach(m => m.init && m.init());
                App.renderNav();
                App.navigate('vide-cerveau');
                App.initSasButtons();
            },
            navigate: (id) => {
                App.currentTab = id;
                document.querySelectorAll('.module-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                App.renderNav();
            },
            renderNav: () => {
                const tabs = [
                    { id: 'vide-cerveau', icon: 'üß†', label: 'Chaos' },
                    { id: 'habits', icon: 'üîÑ', label: 'Rituels' },
                    { id: 'nutrition', icon: 'ü•ó', label: 'Repas' }
                ];
                const dNav = document.getElementById('desktopNav');
                dNav.innerHTML = tabs.map(t => {
                    const active = App.currentTab === t.id;
                    const cl = active ? "bg-[#D946EF]/20 border-[#D946EF]/40 text-white shadow-[0_0_15px_rgba(217,70,239,0.2)]" : "border-transparent text-gray-400 hover:bg-white/5";
                    const ic = active ? "bg-[#D946EF] text-white" : "bg-white/5 text-gray-500";
                    return `<button onclick="App.navigate('${t.id}')" class="w-full flex items-center p-3 rounded-2xl border transition-all ${cl} mb-2">
                        <div class="mr-4 p-2 rounded-xl ${ic} text-xl">${t.icon}</div>
                        <div class="font-bold">${t.label}</div>
                    </button>`;
                }).join('');

                const mNav = document.querySelector('nav.md\\:hidden');
                mNav.innerHTML = tabs.map(t => {
                    const active = App.currentTab === t.id;
                    const cl = active ? "text-[#D946EF] drop-shadow-[0_0_5px_rgba(217,70,239,0.5)]" : "text-gray-500";
                    const sc = active ? "scale-110" : "";
                    return `<button onclick="App.navigate('${t.id}')" class="flex flex-col items-center justify-center w-full py-2 ${cl}">
                        <div class="text-2xl mb-1 transition-transform ${sc}">${t.icon}</div>
                        <span class="text-[10px] font-bold uppercase">${t.label}</span>
                    </button>`;
                }).join('');
            },
            initSasButtons: () => {
                // Intention
                const intentions = [
                    {val:'auto', icon:'üßπ', lbl:'Pilote Auto', desc:'Simple'}, 
                    {val:'focus', icon:'üß†', lbl:'Focus', desc:'Profond'}, 
                    {val:'admin', icon:'üìÇ', lbl:'Admin', desc:'Gestion'}
                ];
                document.getElementById('intentionBtns').innerHTML = intentions.map(i => 
                    `<div onclick="Modules.VideCerveau.selectOption('intention', '${i.lbl}', this)" class="select-card group">
                        <div class="text-3xl icon transition-transform duration-200 group-hover:scale-110 drop-shadow-lg">${i.icon}</div>
                        <div class="text-center leading-tight">
                            <span class="block text-sm font-medium text-gray-300">${i.lbl}</span>
                            <span class="block text-[10px] text-gray-500 mt-1">${i.desc}</span>
                        </div>
                    </div>`
                ).join('');

                // Temps
                const times = [
                    {val:'short', icon:'‚ö°', lbl:'< 15 min'}, 
                    {val:'medium', icon:'‚è≥', lbl:'~ 30 min'}, 
                    {val:'long', icon:'üï∞Ô∏è', lbl:'1h +'}
                ];
                document.getElementById('contextBtns').innerHTML = times.map(i => 
                    `<div onclick="Modules.VideCerveau.selectOption('context', '${i.lbl}', this)" class="select-card group">
                        <div class="text-3xl icon transition-transform duration-200 group-hover:scale-110 drop-shadow-lg">${i.icon}</div>
                        <span class="block text-sm font-medium text-gray-300">${i.lbl}</span>
                    </div>`
                ).join('');

                // Disponibilit√©
                const availabilities = [
                    {val:'solo', icon:'ü§´', lbl:'Solo'}, 
                    {val:'collab', icon:'üì¢', lbl:'Collab'}, 
                    {val:'noise', icon:'üéß', lbl:'Bruit OK'}
                ];
                document.getElementById('availabilityBtns').innerHTML = availabilities.map(i => 
                    `<div onclick="Modules.VideCerveau.selectOption('availability', '${i.lbl}', this)" class="select-card group border-dashed opacity-80 hover:opacity-100">
                        <div class="text-3xl icon transition-transform duration-200 group-hover:scale-110 drop-shadow-lg">${i.icon}</div>
                        <span class="block text-sm font-medium text-gray-300">${i.lbl}</span>
                    </div>`
                ).join('');
            }
        };

        const Modules = {
            VideCerveau: {
                data: [],
                folders: [],
                currentFolder: 'Inbox',
                filter: null,
                
                init: () => {
                    Modules.VideCerveau.data = Utils.Storage.get('tdah_notes');
                    Modules.VideCerveau.data = Modules.VideCerveau.data.map(n => ({ ...n, folder: n.folder || 'Inbox' }));
                    let folders = Utils.Storage.get('tdah_folders');
                    if (folders.length === 0) folders = ['Inbox'];
                    Modules.VideCerveau.folders = folders;
                    Modules.VideCerveau.renderFolders();
                    Modules.VideCerveau.render();
                    document.getElementById('noteInput').addEventListener('keypress', (e) => e.key === 'Enter' && Modules.VideCerveau.add());
                },

                renderFolders: () => {
                    const container = document.getElementById('folderList');
                    container.innerHTML = Modules.VideCerveau.folders.map(f => {
                        const isActive = Modules.VideCerveau.currentFolder === f;
                        const deleteBtn = f !== 'Inbox' ? `<span onclick="Modules.VideCerveau.deleteFolder('${f}', event)" class="folder-delete">√ó</span>` : '';
                        return `<button onclick="Modules.VideCerveau.switchFolder('${f}')" class="folder-tab ${isActive ? 'active' : ''}"><span>${f}</span>${deleteBtn}</button>`
                    }).join('');
                },

                switchFolder: (folderName) => {
                    Modules.VideCerveau.currentFolder = folderName;
                    Modules.VideCerveau.resetFilter();
                    Modules.VideCerveau.renderFolders();
                    Modules.VideCerveau.render();
                },

                addFolder: () => {
                    const name = prompt("Nom du nouveau dossier ?");
                    if (name && !Modules.VideCerveau.folders.includes(name)) {
                        Modules.VideCerveau.folders.push(name);
                        Utils.Storage.set('tdah_folders', Modules.VideCerveau.folders);
                        Modules.VideCerveau.switchFolder(name);
                    }
                },

                deleteFolder: (folderName, e) => {
                    e.stopPropagation();
                    if (folderName === 'Inbox') return;
                    const backupFolders = [...Modules.VideCerveau.folders];
                    const backupData = [...Modules.VideCerveau.data];
                    Modules.VideCerveau.folders = Modules.VideCerveau.folders.filter(f => f !== folderName);
                    Utils.Storage.set('tdah_folders', Modules.VideCerveau.folders);
                    let countMoved = 0;
                    Modules.VideCerveau.data = Modules.VideCerveau.data.map(n => {
                        if (n.folder === folderName) { countMoved++; return { ...n, folder: 'Inbox' }; }
                        return n;
                    });
                    Utils.Storage.set('tdah_notes', Modules.VideCerveau.data);
                    if (Modules.VideCerveau.currentFolder === folderName) Modules.VideCerveau.switchFolder('Inbox');
                    else Modules.VideCerveau.renderFolders();
                    Utils.UI.toast(`Dossier supprim√©. ${countMoved} t√¢ches -> Inbox.`, "info", () => {
                        Modules.VideCerveau.folders = backupFolders;
                        Modules.VideCerveau.data = backupData;
                        Utils.Storage.set('tdah_folders', Modules.VideCerveau.folders);
                        Utils.Storage.set('tdah_notes', Modules.VideCerveau.data);
                        Modules.VideCerveau.renderFolders();
                        Modules.VideCerveau.render();
                    });
                },

                render: () => {
                    const container = document.getElementById('notesList');
                    container.innerHTML = '';
                    let notes = Modules.VideCerveau.data;

                    if (Modules.VideCerveau.filter) {
                        const f = Modules.VideCerveau.filter;
                        if(f.suggestions) {
                            notes = notes.filter(n => f.suggestions.includes(n.text));
                            notes.sort((a, b) => f.suggestions.indexOf(a.text) - f.suggestions.indexOf(b.text));
                        }
                        document.getElementById('vcTitle').innerHTML = `Plan IA <span class="text-[#D946EF] drop-shadow-md">(${notes.length})</span>`;
                        document.getElementById('vcSubtitle').innerText = "Ordre recommand√© de mission.";
                        document.getElementById('resetFilterBtn').classList.remove('hidden');
                        document.getElementById('folderList').parentElement.classList.add('hidden');
                    } else {
                        notes = notes.filter(n => n.folder === Modules.VideCerveau.currentFolder);
                        document.getElementById('vcTitle').innerText = "Mon Chaos";
                        document.getElementById('vcSubtitle').innerText = `Dossier : ${Modules.VideCerveau.currentFolder}`;
                        document.getElementById('resetFilterBtn').classList.add('hidden');
                        document.getElementById('folderList').parentElement.classList.remove('hidden');
                    }

                    if (notes.length === 0) {
                        container.innerHTML = `<div class="text-center py-12 opacity-30 text-xl border-2 border-dashed border-white/10 rounded-3xl">N√©ant. üåå</div>`;
                        return;
                    }

                    notes.forEach((note, index) => {
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-3 p-4 bg-[#020617]/40 border border-white/10 rounded-2xl animate-enter hover:bg-white/5 transition-all hover:border-[#D946EF]/30 group";
                        let orderBadge = Modules.VideCerveau.filter ? `<span class="bg-[#D946EF] text-white font-bold rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2 shadow-[0_0_10px_#D946EF]">${index + 1}</span>` : '';
                        div.innerHTML = `
                            ${orderBadge}
                            <button onclick="Modules.VideCerveau.defuse('${note.id}')" class="p-3 text-[#D946EF] bg-[#D946EF]/10 rounded-xl hover:bg-[#D946EF] hover:text-white transition-colors flex-shrink-0" title="D√©samorcer">‚ú®</button>
                            <span class="flex-grow text-lg text-gray-200 font-medium break-words leading-snug">${note.text}</span>
                            <button onclick="Modules.VideCerveau.delete('${note.id}')" class="p-3 text-gray-500 hover:text-[#06B6D4] hover:bg-[#06B6D4]/10 rounded-xl transition-colors flex-shrink-0">‚úÖ</button>
                        `;
                        container.appendChild(div);
                    });
                },
                add: () => {
                    const input = document.getElementById('noteInput');
                    const text = input.value.trim();
                    if (!text) return;
                    Modules.VideCerveau.data.unshift({ id: Date.now().toString(), text, folder: Modules.VideCerveau.currentFolder, createdAt: new Date() });
                    Utils.Storage.set('tdah_notes', Modules.VideCerveau.data);
                    input.value = '';
                    if(Modules.VideCerveau.filter) Modules.VideCerveau.resetFilter();
                    else Modules.VideCerveau.render();
                },
                delete: (id) => {
                    const deleted = Modules.VideCerveau.data.find(n => n.id === id);
                    const index = Modules.VideCerveau.data.indexOf(deleted);
                    Modules.VideCerveau.data = Modules.VideCerveau.data.filter(n => n.id !== id);
                    Utils.Storage.set('tdah_notes', Modules.VideCerveau.data);
                    Modules.VideCerveau.render();
                    confetti({ particleCount: 30, origin: { y: 0.6 }, colors: ['#D946EF', '#06B6D4'] });
                    Utils.UI.toast("T√¢che termin√©e !", "success", () => {
                        Modules.VideCerveau.data.splice(index, 0, deleted);
                        Utils.Storage.set('tdah_notes', Modules.VideCerveau.data);
                        Modules.VideCerveau.render();
                    });
                },
                
                // --- FILTRE IA ---
                filterSelection: { energy: 'Moyen', intention: null, context: null, availability: null },
                
                updateEnergyLabel: (val) => {
                    const label = document.getElementById('energyText');
                    const container = document.getElementById('energyContainer');
                    let text = "";
                    container.classList.remove('border-red-500', 'border-yellow-500', 'border-green-500', 'bg-red-900/20', 'bg-yellow-900/20', 'bg-green-900/20');
                    if (val < 30) { text = "Batterie Faible üíÄ"; label.className = "text-red-400 font-bold text-lg transition-all"; container.classList.add('border-red-500', 'bg-red-900/20'); }
                    else if (val < 70) { text = "Niveau Stable üòê"; label.className = "text-yellow-400 font-bold text-lg transition-all"; container.classList.add('border-yellow-500', 'bg-yellow-900/20'); }
                    else { text = "Pleine Puissance ‚ö°"; label.className = "text-green-400 font-bold text-lg transition-all"; container.classList.add('border-green-500', 'bg-green-900/20'); }
                    label.innerText = `${text} (${val}%)`;
                },

                selectOption: (type, val, btn) => {
                    if (type === 'availability' && Modules.VideCerveau.filterSelection[type] === val) {
                        Modules.VideCerveau.filterSelection[type] = null;
                        btn.classList.remove('active');
                        return;
                    }
                    Modules.VideCerveau.filterSelection[type] = val;
                    const containerId = type + 'Btns';
                    document.getElementById(containerId).querySelectorAll('.select-card, .energy-card').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                },
                
                applyFilter: async () => {
                    const { intention, context, availability } = Modules.VideCerveau.filterSelection;
                    const energy = document.getElementById('energyRange').value;
                    const energyLabel = document.getElementById('energyText').innerText;

                    if (!intention || !context) { Utils.UI.toast("Param√®tres de mission incomplets"); return; }
                    
                    document.getElementById('partnerLoader').classList.remove('hidden');
                    document.getElementById('partnerContent').classList.add('hidden');
                    
                    const listTxt = Modules.VideCerveau.data.map(n => `- [${n.folder}] ${n.text}`).join('\n');
                    const availPrompt = availability ? `, Disponibilit√©: ${availability}` : "";
                    
                    let prompt = PROMPTS.suggestions
                        .replace('{ENERGY}', energy).replace('{ENERGY_LABEL}', energyLabel)
                        .replace('{INTENTION}', intention).replace('{DURATION}', context)
                        .replace('{SOCIAL}', availPrompt).replace('{TASK_LIST}', listTxt);
                    
                    const res = await Utils.AI.call(prompt, "Calcul de trajectoire", true);
                    
                    document.getElementById('partnerLoader').classList.add('hidden');
                    document.getElementById('partnerContent').classList.remove('hidden');
                    Modals.close('partnerModal');
                    if (res && res.suggestions) {
                        Modules.VideCerveau.filter = res;
                        Modules.VideCerveau.render();
                        confetti({ particleCount: 80, spread: 70, colors: ['#D946EF', '#06B6D4'] });
                    }
                },
                resetFilter: () => { Modules.VideCerveau.filter = null; Modules.VideCerveau.render(); },
                defuse: async (id) => {
                    const note = Modules.VideCerveau.data.find(n => n.id === id);
                    if (!note) return;
                    Modals.showGeneric("‚ú® D√©samor√ßage", '<div class="animate-pulse py-8 text-center text-gray-400">Analyse structurelle...</div>');
                    const res = await Utils.AI.call(PROMPTS.defuse, `T√¢che: "${note.text}"`, true);
                    if (res && res.steps) {
                        Modals.showGeneric("‚ú® D√©samor√ßage", `<div class="bg-white/5 p-4 rounded-xl mb-6 border-l-4 border-[#D946EF] italic text-gray-300">"${note.text}"</div><ul class="space-y-3">${res.steps.map((s,i)=>`<li class="flex gap-3 items-start"><span class="bg-[#D946EF]/20 text-[#D946EF] font-bold rounded-lg w-6 h-6 flex items-center justify-center flex-shrink-0 text-xs mt-0.5">${i+1}</span> <span class="text-gray-200">${s}</span></li>`).join('')}</ul>`);
                    }
                }
            },
            Habits: {
                data: [],
                init: () => {
                    Modules.Habits.data = Utils.Storage.get('tdah_habits');
                    Modules.Habits.render();
                    document.getElementById('habitInput').addEventListener('keypress', (e) => e.key === 'Enter' && Modules.Habits.add());
                },
                render: () => {
                    const container = document.getElementById('habitsList');
                    container.innerHTML = '';
                    const sorted = [...Modules.Habits.data].sort((a, b) => a.createdAt - b.createdAt);
                    sorted.forEach(h => {
                        const isDone = h.lastDate === new Date().toDateString();
                        const div = document.createElement('div');
                        div.className = `flex items-center justify-between p-4 rounded-xl border transition-all cursor-pointer select-none ${isDone ? 'bg-[#06B6D4]/10 border-[#06B6D4]/30 shadow-[0_0_15px_rgba(6,182,212,0.1)]' : 'bg-white/5 border-white/5 hover:bg-white/10'}`;
                        div.onclick = (e) => { if(e.target.tagName !== 'BUTTON') Modules.Habits.toggle(h.id); };
                        div.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${isDone ? 'bg-[#06B6D4] border-[#06B6D4]' : 'border-gray-500'}">
                                    ${isDone ? '<span class="text-white text-xs font-bold">‚úì</span>' : ''}
                                </div>
                                <span class="text-lg font-medium ${isDone ? 'line-through text-[#06B6D4]' : 'text-gray-200'}">${h.text}</span>
                            </div>
                            <button onclick="Modules.Habits.delete('${h.id}', event)" class="text-gray-500 hover:text-red-400 p-2 text-xl">&times;</button>
                        `;
                        container.appendChild(div);
                    });
                },
                add: () => {
                    const input = document.getElementById('habitInput');
                    const text = input.value.trim();
                    if(!text) return;
                    Modules.Habits.data.push({ id: Date.now().toString(), text, lastDate: null, createdAt: Date.now() });
                    Utils.Storage.set('tdah_habits', Modules.Habits.data);
                    input.value = '';
                    Modules.Habits.render();
                },
                toggle: (id) => {
                    const today = new Date().toDateString();
                    Modules.Habits.data = Modules.Habits.data.map(h => {
                        if(h.id !== id) return h;
                        const isDone = !(h.lastDate === today);
                        if(isDone) confetti({ particleCount: 30, origin: { y: 0.7 }, colors: ['#06B6D4'] });
                        return { ...h, lastDate: isDone ? today : null };
                    });
                    Utils.Storage.set('tdah_habits', Modules.Habits.data);
                    Modules.Habits.render();
                },
                delete: (id, e) => {
                    e.stopPropagation();
                    const habit = Modules.Habits.data.find(h => h.id === id);
                    Modules.Habits.data = Modules.Habits.data.filter(h => h.id !== id);
                    Utils.Storage.set('tdah_habits', Modules.Habits.data);
                    Modules.Habits.render();
                    Utils.UI.toast("Habitude supprim√©e", "info", () => {
                        Modules.Habits.data.push(habit);
                        Utils.Storage.set('tdah_habits', Modules.Habits.data);
                        Modules.Habits.render();
                    });
                }
            },
            Nutrition: {
                init: () => {
                    Modules.Nutrition.renderToday();
                    document.getElementById('chatInput').addEventListener('keypress', (e) => e.key === 'Enter' && Modules.Nutrition.askBot());
                },
                renderToday: () => {
                    const todayName = CONFIG.DAYS[new Date().getDay()];
                    const menu = CONFIG.MENU_DATA[todayName];
                    document.getElementById('menuDay').innerText = todayName;
                    document.getElementById('menuMidi').innerText = menu.m;
                    document.getElementById('menuSoir').innerText = menu.s;
                },
                toggleWeekView: () => {
                    const container = document.getElementById('weekView');
                    const btn = document.getElementById('toggleWeekBtn');
                    if (container.classList.contains('hidden')) {
                        container.classList.remove('hidden');
                        container.innerHTML = CONFIG.DAYS.map(d => 
                            d !== CONFIG.DAYS[new Date().getDay()] ? 
                            `<div class="bg-black/20 border border-white/5 rounded-xl p-3 text-sm text-gray-300"><strong class="text-[#8B5CF6] block">${d}</strong> Midi: ${CONFIG.MENU_DATA[d].m} / Soir: ${CONFIG.MENU_DATA[d].s}</div>` : ''
                        ).join('');
                        btn.innerText = "Masquer la semaine";
                    } else {
                        container.classList.add('hidden');
                        btn.innerText = "Voir toute la semaine";
                    }
                },
                getRecipe: async (type) => {
                    const todayName = CONFIG.DAYS[new Date().getDay()];
                    const meal = type === 'midi' ? CONFIG.MENU_DATA[todayName].m : CONFIG.MENU_DATA[todayName].s;
                    Modals.showGeneric("Recette Express", '<div class="animate-pulse text-center py-4">Le Chef r√©fl√©chit...</div>');
                    const text = await Utils.AI.call(PROMPTS.recipe, `Recette simple pour: "${meal}".`);
                    if(text) Modals.showGeneric("Recette Express", marked.parse(text));
                },
                askBot: async () => {
                    const input = document.getElementById('chatInput');
                    const q = input.value.trim();
                    if(!q) return;
                    const box = document.getElementById('chatResponse');
                    box.classList.remove('hidden');
                    box.innerHTML = '<div class="animate-pulse">R√©flexion...</div>';
                    const text = await Utils.AI.call(PROMPTS.nutrition, q);
                    if(text) { box.innerHTML = marked.parse(text); input.value = ''; }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>